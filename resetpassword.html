<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password</title>
  <link rel="stylesheet" href="resetpassword.css" />
</head>
<body>
  <div class="bubbles">
    <span></span><span></span><span></span>
    <span></span><span></span><span></span>
  </div>

  <div class="container">
    <div class="logo">DUROH</div>
    <div class="card">
      <h2 class="title">Reset Password</h2>
      <p class="subtitle">Enter a new password below</p>

      <form id="resetForm" class="simple-form">
        <div class="form-group">
          <label for="new-password">New Password</label>
          <div class="input-wrapper">
            <input type="password" id="new-password" placeholder="Enter new password" required />
            <span id="toggleNew" class="toggle-password">üëÅ</span>
          </div>
        </div>
        <div class="form-group">
          <label for="confirm-password">Confirm Password</label>
          <div class="input-wrapper">
            <input type="password" id="confirm-password" placeholder="Confirm new password" required />
            <span id="toggleConfirm" class="toggle-password">üëÅ</span>
          </div>
        </div>
        <button type="submit" id="submitBtn">Reset Password</button>
      </form>
    </div>
  </div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabaseUrl = "https://xvnzrighraugigzqsxyh.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2bnpyaWdocmF1Z2lnenFzeHloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDIyNzUsImV4cCI6MjA3MjM3ODI3NX0.7o5Z30AhbZkAuLq9mgaQptAeV3zFIyT_KJt4hOcRBJ0";
const supabase = createClient(supabaseUrl, supabaseKey);

document.addEventListener("DOMContentLoaded", async () => {
  // Get access token from URL
  const urlParams = new URLSearchParams(window.location.search);
  const access_token = urlParams.get("access_token");
  if (!access_token) {
    alert("Invalid or missing password reset link.");
    window.location.href = "login.html";
    return;
  }

  // Set the session with the token so Supabase knows the user
  const { data, error: sessionError } = await supabase.auth.setSession({ access_token });
  if (sessionError) {
    alert("Session setup failed: " + sessionError.message);
    window.location.href = "login.html";
    return;
  }

  const form = document.getElementById("resetForm");
  const newPasswordInput = document.getElementById("new-password");
  const confirmPasswordInput = document.getElementById("confirm-password");
  const submitBtn = document.getElementById("submitBtn");

  // Toggle password visibility
  document.getElementById("toggleNew").addEventListener("click", () => {
    newPasswordInput.type = newPasswordInput.type === "password" ? "text" : "password";
  });
  document.getElementById("toggleConfirm").addEventListener("click", () => {
    confirmPasswordInput.type = confirmPasswordInput.type === "password" ? "text" : "password";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const newPassword = newPasswordInput.value.trim();
    const confirmPassword = confirmPasswordInput.value.trim();

    if (newPassword !== confirmPassword) {
      alert("Passwords do not match!");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Resetting...";

    // Update password now that session is active
    const { error } = await supabase.auth.updateUser({ password: newPassword });

    if (error) {
      alert("Failed to reset password: " + error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = "Reset Password";
    } else {
      alert("Password reset successfully!");
      window.location.href = "login.html";
    }
  });
});
</script>
</body>
</html>
